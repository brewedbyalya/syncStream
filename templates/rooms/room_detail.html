{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 mobile-stack">
    <div>
        <h2 class="text-shadow mb-1">{{ room.name }}</h2>
        <p class="text-muted mb-0">
            Created by {{ room.creator.username }} • 
            <span id="online-count">{{ room.get_online_users_count }}</span> 
        </p>
    </div>
    <div class="d-flex mobile-stack mobile-margin">
        {% if room.creator == user %}
            <a href="{% url 'rooms:edit_room' room.id %}" class="btn btn-outline-primary btn-sm me-2">
                <i class="fas fa-edit me-1"></i>Edit Room
            </a>
        {% endif %}
        <form action="{% url 'rooms:leave_room' room.id %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt me-1"></i>Leave Room
            </button>
        </form>
    </div>
</div>

{% if room.allow_screen_share %}
<div class="mb-3">
    <div class="card card-gradient">
        <div class="card-body text-center py-2">
            <button id="start-screen-share" class="btn btn-primary me-2">
                <i class="fas fa-desktop me-2"></i>Start Screen Share
            </button>
            <button id="stop-screen-share" class="btn btn-danger d-none">
                <i class="fas fa-stop me-2"></i>Stop Screen Share
            </button>
            <div class="mt-1">
                <small class="text-muted">Share your screen with other participants</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="room-layout">
    <div class="video-section">
        <div class="card card-gradient">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-play-circle me-2"></i>Video Player</span>
                    <div>
                        <span class="badge badge-gradient me-2" id="connection-status">Connected</span>
                        <span class="badge bg-secondary" id="online-count-badge">{{ room.get_online_users_count }} online</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="video-container-wrapper">
                    <div id="video-container" class="bg-dark">
                        <div id="player-placeholder" class="d-flex flex-column justify-content-center align-items-center text-white h-100">
                            <i class="fas fa-play-circle fa-3x mb-3 text-muted"></i>
                            <p class="text-center mb-1">No video playing</p>
                            <small class="text-muted">Enter a URL below to get started</small>
                        </div>
                    </div>
                    
                    <div id="screen-share-container" class="d-none"></div>
                </div>
                
                <div class="video-controls d-none video-controls-glass" id="video-controls">
                    <button id="play-btn" title="Play" class="btn-control">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="pause-btn" title="Pause" class="btn-control">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button id="sync-btn" title="Sync with others" class="btn-control">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button id="fullscreen-btn" title="Fullscreen" class="btn-control">
                        <i class="fas fa-expand"></i>
                    </button>
                    <div class="video-info ms-2">
                        <small class="text-light">
                            <span id="video-type-display">None</span> • 
                            Latency: <span id="latency-display">0ms</span>
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="video-url-input" class="form-control" 
                           placeholder="Enter YouTube URL, Vimeo URL, or direct video link..." 
                           aria-label="Video URL">
                    <button id="load-video" class="btn btn-primary" onclick="loadVideo()">
                        <i class="fas fa-play me-1"></i>Load
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Supported: YouTube, Vimeo, MP4, WebM, and other video formats</small>
                </div>
            </div>
        </div>

        {% if isRoomCreator and invite_info %}
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('invite-section')">
                <h5 class="mb-0"><i class="fas fa-share-alt me-2"></i>Invite Others</h5>
                <i class="fas fa-chevron-down toggle-icon" id="invite-icon"></i>
            </div>
            <div class="collapsible-content" id="invite-section">
                <div class="card card-gradient">
                    <div class="card-body">
                        <p class="mb-3">Share this link to invite others to your room:</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" value="{{ invite_info }}" id="inviteLink" readonly>
                            <button class="btn btn-primary" onclick="copyInviteLink()">
                                <i class="fas fa-copy me-1"></i>Copy
                            </button>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This link contains the room password. Anyone with this link can join your room.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if room.creator == user %}
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('banned-words-section')">
                <h5 class="mb-0"><i class="fas fa-ban me-2"></i>Banned Words</h5>
                <i class="fas fa-chevron-down toggle-icon" id="banned-words-icon"></i>
            </div>
            <div class="collapsible-content" id="banned-words-section">
                <div class="card card-gradient">
                    <div class="card-body">
                        <div class="banned-words-container">
                            <div class="d-flex mb-3">
                                <input type="text" id="banned-word-input" class="form-control me-2" 
                                       placeholder="Enter word to ban..." maxlength="50">
                                <button class="btn btn-danger" onclick="addBannedWord()">
                                    <i class="fas fa-plus me-1"></i>Add
                                </button>
                            </div>
                            
                            <div id="banned-words-list" class="banned-words-list">
                                <div class="text-center text-muted" id="no-banned-words">
                                    <i class="fas fa-ban fa-2x mb-2"></i>
                                    <p>No banned words yet</p>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Messages containing banned words will be automatically blocked.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card card-gradient mt-3">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Room Information
            </div>
            <div class="card-body">
                <div class="room-info-grid">
                    <div class="col-md-6 mb-2">
                        <strong>Status:</strong>
                        <span class="badge bg-{% if room.is_active %}success{% else %}danger{% endif %}">
                            {% if room.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Privacy:</strong>
                        <span class="badge bg-{% if room.is_private %}warning{% else %}info{% endif %}">
                            {% if room.is_private %}Private{% else %}Public{% endif %}
                        </span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Screen Share:</strong>
                        <span class="badge bg-{% if room.allow_screen_share %}success{% else %}secondary{% endif %}">
                            {% if room.allow_screen_share %}Enabled{% else %}Disabled{% endif %}
                        </span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Chat:</strong>
                        <span class="badge bg-{% if room.allow_chat %}success{% else %}secondary{% endif %}">
                            {% if room.allow_chat %}Enabled{% else %}Disabled{% endif %}
                        </span>
                    </div>
                    <div class="col-md-12">
                        <strong>Max Users:</strong> <p class="max-users">{{ room.max_users }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar-section">
  <div class="card card-gradient h-100">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <i class="fas fa-comments me-2"></i>
            <span>Chat</span>
            <span class="badge bg-secondary ms-2" id="message-count">{{ messages|length }}</span>
        </div>
        <span id="chat-indicator" class="badge badge-gradient">Connected</span>
    </div>
    <div class="card-body p-0">
        <div id="chat-messages" class="chat-messages chat-messages-glass custom-scrollbar">
        {% for message in messages %}
        <div class="message-container" data-message-id="{{ message.id }}">
            <div class="message {% if message.user == user %}message-self{% elif message.user.username == 'System' %}message-system{% else %}message-other{% endif %}">
                <strong>{{ message.user.username }}</strong>
                <span class="message-content">{{ message.message }}</span>
                <small>
                    <i class="fas fa-clock me-1"></i>{{ message.created_at|time }}
                    {% if message.user == user %}
                    <span class="message-status"><i class="fas fa-check-double text-info"></i></span>
                    {% endif %}
                </small>
                
                {% if room.creator == user %}
                <button class="btn btn-sm btn-link text-danger delete-message-btn" 
                        onclick="deleteMessage('{{ message.id }}')"
                        title="Delete message">
                    <i class="fas fa-trash-alt"></i>
                </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-comments fa-3x mb-2"></i>
            <p>No messages yet. Start the conversation!</p>
        </div>
        {% endfor %}
        </div>
        
            <div id="typing-indicator" class="typing-indicator d-none">
                <div class="d-flex align-items-center px-3 py-2">
                    <span id="typing-users" class="text-muted me-2"></span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
    
    <div class="card-footer">
        <div class="input-group">
            <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." autocomplete="off">
            <button id="chat-send" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="mt-2">
            <small class="text-muted">Press Enter to send</small>
        </div>
    </div>
</div>
        </div>

<div class="collapsible-section">
    <div class="collapsible-header" onclick="toggleCollapsible('quick-actions-section')">
        <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
        <i class="fas fa-chevron-down toggle-icon" id="quick-actions-icon"></i>
    </div>
    <div class="collapsible-content" id="quick-actions-section">
        <div class="card card-gradient">
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="copyRoomUrl()">
                        <i class="fas fa-link me-2"></i>Copy Room Link
                    </button>
                    <button class="btn btn-outline-info" onclick="copyVideoUrl()">
                        <i class="fas fa-video me-2"></i>Copy Video URL
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showKeyboardShortcuts()">
                        <i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts
                    </button>
                    {% if room.creator == user %}
                    <a href="{% url 'rooms:edit_room' room.id %}" class="btn btn-outline-warning">
                        <i class="fas fa-cog me-2"></i>Room Settings
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

   <div class="collapsible-section">
    <div class="collapsible-header" onclick="toggleCollapsible('participants-section')">
        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Participants ({{ room.participants.count }})</h5>
        <i class="fas fa-chevron-down toggle-icon" id="participants-icon"></i>
    </div>
    <div class="collapsible-content" id="participants-section">
        <div class="card card-gradient">
            <div class="card-body">
                <div class="participants-grid">
                    {% for participant in room.participants.all %}
                    <div class="participant-card {% if participant.is_online %}participant-card-online{% else %}participant-card-offline{% endif %} {% if participant.user == room.creator %}participant-card-creator{% endif %} {% if participant.is_currently_muted %}participant-muted{% endif %} {% if participant.is_banned %}participant-banned{% endif %}"
     data-user-id="{{ participant.user.id }}">
    <div class="participant-avatar">
        <i class="fas fa-user"></i>
        {% if participant.is_currently_muted %}
        <span class="muted-badge" title="Muted">
            <i class="fas fa-volume-mute"></i>
        </span>
        {% endif %}
        {% if participant.is_banned %}
        <span class="banned-badge" title="Banned">
            <i class="fas fa-ban"></i>
        </span>
        {% endif %}
    </div>
    <strong class="participant-name">{{ participant.user.username }}</strong>
    {% if participant.user == room.creator %}
    <div class="text-warning small">
        <i class="fas fa-crown" title="Room Creator"></i> Creator
    </div>
    {% endif %}
    <div class="small">
        {% if participant.is_online %}
        <span class="status-online" title="Online">● Online</span>
        {% else %}
        <span class="status-offline" title="Offline">● Offline</span>
        {% endif %}
    </div>
    
    {% if room.creator == user and participant.user != user %}
    <div class="participant-actions">
            {% if participant.is_currently_muted %}
            <button class="btn btn-sm btn-success" 
                    onclick="unmuteUser('{{ participant.user.id }}', '{{ participant.user.username|escapejs }}')"
                    title="Unmute user">
                <i class="fas fa-volume-up"></i>
            </button>
            {% else %}
            <button class="btn btn-sm btn-warning" 
                    onclick="showMuteModal('{{ participant.user.id }}', '{{ participant.user.username|escapejs }}')"
                    title="Mute user">
                <i class="fas fa-volume-mute"></i>
            </button>
            {% endif %}
        
            <button class="btn btn-sm btn-danger" 
                    onclick="kickUser('{{ participant.user.id }}', '{{ participant.user.username|escapejs }}')"
                    title="Kick user from room">
                <i class="fas fa-user-times"></i>
            </button>
        
            {% if participant.is_banned %}
            <button class="btn btn-sm btn-success" 
                    onclick="unbanUser('{{ participant.user.id }}', '{{ participant.user.username|escapejs }}')"
                    title="Unban user">
                <i class="fas fa-user-check"></i>
            </button>
            {% else %}
            <button class="btn btn-sm btn-danger" 
                    onclick="banUser('{{ participant.user.id }}', '{{ participant.user.username|escapejs }}')"
                    title="Permanently ban user">
                <i class="fas fa-ban"></i>
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="muteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content card-glass">
            <div class="modal-header">
                <h5 class="modal-title">Mute User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Mute <strong id="muteUserName"></strong> for:</p>
                <div class="btn-group-vertical w-100" role="group">
                    <button type="button" class="btn btn-outline-warning" onclick="muteUser(5)">
                        5 Minutes
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="muteUser(15)">
                        15 Minutes
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="muteUser(30)">
                        30 Minutes
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="muteUser(60)">
                        1 Hour
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="keyboardShortcutsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content card-glass">
            <div class="modal-header">
                <h5 class="modal-title">Keyboard Shortcuts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="shortcut-item">
                    <span class="shortcut-key">Space</span>
                    <span class="shortcut-description">Play/Pause video</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-key">F</span>
                    <span class="shortcut-description">Toggle fullscreen</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-key">S</span>
                    <span class="shortcut-description">Sync video with others</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-key">Enter</span>
                    <span class="shortcut-description">Send chat message</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const roomId = "{{ room.id }}";
    const userId = "{{ user.id }}";
    const username = "{{ user.username }}";
    const isRoomCreator = "{{ room.creator.id }}" === "{{ user.id }}";
    const roomUrl = window.location.href;
    
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof roomId !== 'undefined' && typeof userId !== 'undefined') {
            webRTCManager = new WebRTCManager(roomId, userId, username || 'User');
        }
    });
</script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="{% static 'js/webrtc.js' %}"></script>
<script src="{% static 'js/room.js' %}"></script>
<script>

function deleteMessage(messageId) {    
    if (!messageId || messageId === 'undefined') {
        showNotification('Cannot delete message: Invalid message ID', 'error');
        return;
    }
    
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    let messageContent = '';
    let username = '';
    
    if (messageElement) {
        const contentElement = messageElement.querySelector('.message-content');
        const usernameElement = messageElement.querySelector('strong');
        if (contentElement) messageContent = contentElement.textContent;
        if (usernameElement) username = usernameElement.textContent;
    }
    
    const truncatedMessage = messageContent.length > 50 ? messageContent.substring(0, 50) + '...' : messageContent;
    
    if (!confirm(`Are you sure you want to delete this message?\n\n"${truncatedMessage}"\n- by ${username}`)) {
        return;
    }
    
    fetch(`/rooms/${roomId}/messages/${messageId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            if (messageElement) {
                messageElement.remove();
                updateMessageCount();
            }
            showNotification('Message deleted successfully', 'success');
        } else {
            showNotification('Failed to delete message: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showNotification('Error deleting message: ' + error.message, 'error');
    });
}

let muteUserId = null;
let muteUserName = '';

function showMuteModal(userId, userName) {
    muteUserId = userId;
    muteUserName = userName;
    document.getElementById('muteUserName').textContent = userName;
    new bootstrap.Modal(document.getElementById('muteUserModal')).show();
}

function muteUser(duration) {
    if (!muteUserId) return;
    
    const formData = new FormData();
    formData.append('duration', duration);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch(`/rooms/${roomId}/users/${muteUserId}/mute/`, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Muted ${muteUserName} for ${duration} minutes`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('muteUserModal')).hide();
            updateParticipantMuteStatus(muteUserId, true);
        } else {
            showNotification('Failed to mute user: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error muting user', 'error');
    });
}

function unmuteUser(userId, userName) {
    if (!confirm(`Unmute ${userName}?`)) return;
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch(`/rooms/${roomId}/users/${userId}/unmute/`, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Unmuted ${userName}`, 'success');
            updateParticipantMuteStatus(userId, false);
        } else {
            showNotification('Failed to unmute user: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error unmuting user', 'error');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'chat_message':
            appendMessage(data.username, data.message, data.timestamp, data.message_id);
            break;
            
        case 'message_deleted':
            const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
            if (messageElement) {
                messageElement.remove();
                showNotification(`Message "${data.message_content}" by ${data.message_author} was deleted by ${data.deleted_by}`, 'info');
            }
            break;
            
        case 'user_muted':
            showNotification(`${data.username} was muted by ${data.muted_by} for ${data.duration} minutes`, 'warning');
            updateParticipantMuteStatus(data.user_id, true);
            break;
            
        case 'user_unmuted':
            showNotification(`${data.username} was unmuted by ${data.unmuted_by}`, 'success');
            updateParticipantMuteStatus(data.user_id, false);
            break;
            
        case 'video_control':
            handleVideoControl(data);
            break;
            
        case 'screen_share_started':
            handleScreenShareStarted(data);
            break;
            
        case 'screen_share_ended':
            handleScreenShareEnded(data);
            break;
            
        case 'user_joined':
            userJoined(data.username);
            break;

        case 'banned_word_added':
            handleBannedWordAdded(data);
            break;
            
        case 'banned_word_removed':
            handleBannedWordRemoved(data);
            
        case 'user_left':
            userLeft(data.username);
            break;
            
        case 'webrtc_signal':
            handleWebRTCSignal(data);
            break;

        case 'user_kicked':
            handleUserKicked(data);
            break;
            
        case 'you_were_kicked':
            handleYouWereKicked(data);
            break;
            
        case 'user_banned':
            handleUserBanned(data);
            break;

        case 'you_were_banned':
            handleYouWereBanned(data);
            break;

        case 'user_unbanned':
            handleUserUnbanned(data);
            break;
        
        case 'pong':
            handlePingPong(data);
            break;
            
        default:
            console.log('Unknown message type:', data.type);
    }
}

function updateParticipantMuteStatus(userId, isMuted) {
    const participantElement = document.querySelector(`.participant-card[data-user-id="${userId}"]`);
    if (participantElement) {
        if (isMuted) {
            participantElement.classList.add('participant-muted');
            if (!participantElement.querySelector('.muted-badge')) {
                const avatar = participantElement.querySelector('.participant-avatar');
                if (avatar) {
                    const mutedBadge = document.createElement('span');
                    mutedBadge.className = 'muted-badge';
                    mutedBadge.title = 'Muted';
                    mutedBadge.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    avatar.appendChild(mutedBadge);
                }
            }
            const muteBtn = participantElement.querySelector('.btn-warning');
            if (muteBtn) {
                muteBtn.classList.replace('btn-warning', 'btn-success');
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                const userName = participantElement.querySelector('.participant-name').textContent;
                muteBtn.onclick = function() {
                    unmuteUser(userId, userName);
                };
            }
        } else {
            participantElement.classList.remove('participant-muted');
            const mutedBadge = participantElement.querySelector('.muted-badge');
            if (mutedBadge) {
                mutedBadge.remove();
            }
            const unmuteBtn = participantElement.querySelector('.btn-success');
            if (unmuteBtn) {
                unmuteBtn.classList.replace('btn-success', 'btn-warning');
                unmuteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                const userName = participantElement.querySelector('.participant-name').textContent;
                unmuteBtn.onclick = function() {
                    showMuteModal(userId, userName);
                };
            }
        }
    }
}

function appendMessage(username, message, timestamp, messageId) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message-container');
    messageElement.setAttribute('data-message-id', messageId);
    
    const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
    const sanitizedMessage = message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    let deleteButton = '';
    if (isRoomCreator) {
        const escapedMessage = sanitizedMessage.replace(/'/g, "\\'").replace(/"/g, '\\"');
        const escapedUsername = username.replace(/'/g, "\\'").replace(/"/g, '\\"');
        
        deleteButton = `
            <button class="btn btn-sm btn-link text-danger delete-message-btn" 
                    onclick="confirmDeleteMessage('${messageId}', '${escapedMessage}', '${escapedUsername}')"
                    title="Delete message">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
    }
    
    messageElement.innerHTML = `
        <div class="mb-2 message ${username === "{{ user.username }}" ? 'message-self' : username === 'System' ? 'message-system' : 'message-other'} fade-in">
            <strong class="${username === "{{ user.username }}" ? 'text-primary' : username === 'System' ? 'text-warning' : 'text-info'}">
                ${username}:
            </strong> 
            <span class="message-content">${sanitizedMessage}</span>
            <small class="text-muted ms-2">${time}</small>
            ${deleteButton}
        </div>
    `;
    
    if (chatMessages) {
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function copyInviteLink() {
    const copyText = document.getElementById("inviteLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
    showNotification("Invite link copied to clipboard!", "success");
}

function copyRoomUrl() {
    navigator.clipboard.writeText(roomUrl).then(() => {
        showNotification('Room link copied to clipboard!', 'success');
    }).catch(err => {
        showNotification('Failed to copy room link', 'error');
    });
}

function copyVideoUrl() {
    const videoUrl = document.getElementById('video-url-input').value;
    if (videoUrl) {
        navigator.clipboard.writeText(videoUrl).then(() => {
            showNotification('Video URL copied to clipboard!', 'success');
        }).catch(err => {
            showNotification('Failed to copy video URL', 'error');
        });
    } else {
        showNotification('No video URL to copy', 'warning');
    }
}

function showKeyboardShortcuts() {
    new bootstrap.Modal(document.getElementById('keyboardShortcutsModal')).show();
}

function showNotification(message, type = 'info') {
    document.querySelectorAll('.notification-container').forEach(alert => alert.remove());
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show notification-container glass-effect`;
    
    const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${icons[type] || 'info-circle'} me-2"></i>
            <div>${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('msfullscreenchange', handleFullscreenChange);

function handleFullscreenChange() {
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
        if (document.fullscreenElement) {
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = 'Exit Fullscreen';
        } else {
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'Fullscreen';
        }
    }
}

document.addEventListener('keydown', function(e) {
    if (e.code === 'Space' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        if (typeof playVideo === 'function' && typeof pauseVideo === 'function') {
            if (isPlaying) {
                pauseVideo();
            } else {
                playVideo();
            }
        }
    }
    
    if (e.code === 'KeyF' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        toggleFullscreen();
    }
    
    if (e.code === 'KeyS' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        if (typeof syncVideo === 'function') {
            syncVideo();
        }
    }
});

function toggleFullscreen() {
    const videoContainer = document.getElementById('video-container');
    
    if (!document.fullscreenElement) {
        if (videoContainer.requestFullscreen) {
            videoContainer.requestFullscreen().catch(err => {
                console.error('Error attempting to enable fullscreen:', err);
            });
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullscreen);
    }
});

function addBannedWord() {
    const wordInput = document.getElementById('banned-word-input');
    const word = wordInput.value.trim();
    
    if (!word) {
        showNotification('Please enter a word to ban', 'warning');
        return;
    }
    
    if (word.length < 2) {
        showNotification('Word must be at least 2 characters', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('word', word);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch(`/rooms/${roomId}/banned-words/add/`, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            wordInput.value = '';
            showNotification(data.message, 'success');
        } else {
            showNotification('Failed to add banned word: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error adding banned word', 'error');
    });
}

function removeBannedWord(word) {
    if (!confirm(`Remove "${word}" from banned words?`)) return;
    
    const formData = new FormData();
    formData.append('word', word);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch(`/rooms/${roomId}/banned-words/remove/`, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification('Failed to remove banned word: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error removing banned word', 'error');
    });
}

function addBannedWordToUI(word) {
    const container = document.getElementById('banned-words-list');
    const emptyState = document.getElementById('no-banned-words');
    
    if (emptyState && emptyState.style.display !== 'none') {
        emptyState.style.display = 'none';
    }
    
    const existingWords = container.querySelectorAll('.banned-word-text');
    for (const element of existingWords) {
        if (element.textContent === word) {
            return;
        }
    }
    
    const wordElement = document.createElement('div');
    wordElement.className = 'banned-word-item';
    wordElement.innerHTML = `
        <span class="banned-word-text">${word}</span>
        <button class="btn btn-sm btn-outline-danger" 
                onclick="removeBannedWord('${word.replace(/'/g, "\\'")}')"
                title="Remove banned word">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(wordElement);
}

function removeBannedWordFromUI(word) {
    const container = document.getElementById('banned-words-list');
    const wordElements = container.querySelectorAll('.banned-word-item');
    
    wordElements.forEach(element => {
        const wordText = element.querySelector('.banned-word-text').textContent;
        if (wordText === word) {
            element.remove();
        }
    });
    
    if (container.children.length === 0) {
        const emptyState = document.getElementById('no-banned-words');
        if (emptyState) {
            emptyState.style.display = 'block';
        }
    }
}

function loadBannedWords() {
    if (!isRoomCreator) return;
    
    fetch(`/rooms/${roomId}/banned-words/`, {
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayBannedWords(data.banned_words);
        }
    })
    .catch(error => {
        console.error('Error loading banned words:', error);
    });
}

function displayBannedWords(words) {
    const container = document.getElementById('banned-words-list');
    const emptyState = document.getElementById('no-banned-words');
    
    if (!container) {
        console.error('Banned words container not found');
        return;
    }
        
    if (!words || words.length === 0) {
        if (emptyState) {
            emptyState.style.display = 'block';
        }
        container.innerHTML = '';
        if (emptyState) {
            container.appendChild(emptyState);
        }
    } else {
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        words.forEach(word => {
            const wordElement = document.createElement('div');
            wordElement.className = 'banned-word-item';
            wordElement.innerHTML = `
                <span class="banned-word-text">${word}</span>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="removeBannedWord('${word.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"
                        title="Remove banned word">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(wordElement);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const bannedWordInput = document.getElementById('banned-word-input');
    if (bannedWordInput) {
        bannedWordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addBannedWord();
            }
        });
    }
});

function toggleCollapsible(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId.replace('section', 'icon'));
    
    section.classList.toggle('active');
    icon.classList.toggle('rotated');
    
    if (section.classList.contains('active')) {
        document.querySelectorAll('.collapsible-content').forEach(content => {
            if (content.id !== sectionId && content.classList.contains('active')) {
                content.classList.remove('active');
                const otherIcon = document.getElementById(content.id.replace('section', 'icon'));
                if (otherIcon) otherIcon.classList.remove('rotated');
            }
        });
    }
}


function showTypingIndicator(username) {
    const indicator = document.getElementById('typing-indicator');
    const typingUsers = document.getElementById('typing-users');
    
    typingUsers.textContent = `${username} is typing...`;
    indicator.classList.remove('d-none');
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    indicator.classList.add('d-none');
}

let typingTimer;
document.getElementById('chat-input').addEventListener('input', function() {
    
    clearTimeout(typingTimer);
    typingTimer = setTimeout(hideTypingIndicator, 2000);
});

function updateMessageCount() {
    const count = document.querySelectorAll('.message-container').length;
    const countElement = document.getElementById('message-count');
    if (countElement) {
        countElement.textContent = count;
    }
}

updateMessageCount();

</script>
{% endblock %}