{% extends 'base.html' %}
{% load static %}

{% block profile_css %}
<link href="{% static 'css/profile.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="profile-edit-container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card profile-edit-card card-gradient">
                <div class="card-header profile-edit-header">
                    <h3 class="profile-edit-title">
                        <i class="fas fa-user-edit me-2"></i>Edit Profile
                    </h3>
                    <p class="profile-edit-subtitle">Update your personal information</p>
                </div>
                <div class="card-body profile-edit-body">
                    <form method="post" enctype="multipart/form-data" class="profile-edit-form">
                        {% csrf_token %}
                        
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-camera me-2"></i>Profile Picture
                            </h5>
                            <div class="profile-picture-edit">
                                <div class="current-avatar">
                                    {% if user.profile_picture %}
                                        <img src="{{ user.profile_picture.url }}" alt="Current profile picture" class="current-profile-picture">
                                    {% else %}
                                        <div class="default-avatar">
                                            <i class="fas fa-user-circle"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="upload-control">
                                    <label for="{{ form.profile_picture.id_for_label }}" class="upload-label">
                                        <i class="fas fa-upload me-2"></i>Choose New Image
                                    </label>
                                    {{ form.profile_picture }}
                                    <small class="upload-help">Recommended: 200x200 pixels, JPG or PNG</small>
                                </div>
                                {% if form.profile_picture.errors %}
                                <div class="error-text">
                                    {% for error in form.profile_picture.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-info-circle me-2"></i>Basic Information
                            </h5>
                            
                            <div class="form-group">
                                <label for="{{ form.username.id_for_label }}" class="form-label">
                                    <i class="fas fa-user me-2"></i>Username
                                </label>
                                {{ form.username }}
                                {% if form.username.errors %}
                                <div class="error-text">
                                    {% for error in form.username.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    <i class="fas fa-envelope me-2"></i>Email Address
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                <div class="error-text">
                                    {% for error in form.email.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-pencil-alt me-2"></i>About Me
                            </h5>
                            <div class="form-group">
                                <label for="{{ form.bio.id_for_label }}" class="form-label">
                                    <i class="fas fa-quote-left me-2"></i>Bio
                                </label>
                                {{ form.bio }}
                                <div class="form-help">Tell other users about yourself (max 500 characters)</div>
                                {% if form.bio.errors %}
                                <div class="error-text">
                                    {% for error in form.bio.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                            <a href="{% url 'profile' %}" class="btn btn-cancel">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card danger-zone-card card-gradient mt-4">
                <div class="card-header danger-zone-header">
                    <h5 class="danger-zone-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                    </h5>
                </div>
                <div class="card-body">
                    <div class="danger-zone-content">
                        <h6>Account Actions</h6>
                        <p class="danger-zone-warning">
                            <i class="fas fa-info-circle me-2"></i>These actions are irreversible. Proceed with caution.
                        </p>
                        
                        <div class="danger-zone-actions">
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                <i class="fas fa-trash me-2"></i>Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content card-glass">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    Delete Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <i class="fas fa-exclamation-circle fa-2x text-danger mb-3"></i>
                    <h6>Are you absolutely sure?</h6>
                    <p>This action cannot be undone. This will permanently delete your account and all associated data, including:</p>
                    <ul>
                        <li>All rooms you created</li>
                        <li>Your chat messages</li>
                        <li>Your profile information</li>
                        <li>All participation history</li>
                    </ul>
                </div>
                <div class="confirmation-input">
                    <label for="confirmUsername" class="form-label">
                        Type your username to confirm: <strong>{{ user.username }}</strong>
                    </label>
                    <input type="text" class="form-control" id="confirmUsername" placeholder="Enter your username">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete" disabled>
                    <i class="fas fa-trash me-2"></i>Permanently Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmInput = document.getElementById('confirmUsername');
    const confirmButton = document.getElementById('confirmDelete');
    const username = '{{ user.username }}';
    
    confirmInput.addEventListener('input', function() {
        confirmButton.disabled = this.value !== username;
    });
    
    const fileInput = document.getElementById('id_profile_picture');
    const currentPicture = document.querySelector('.current-profile-picture');
    const defaultAvatar = document.querySelector('.default-avatar');
    
    fileInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (currentPicture) {
                    currentPicture.src = e.target.result;
                } else if (defaultAvatar) {
                    defaultAvatar.innerHTML = `<img src="${e.target.result}" class="current-profile-picture" alt="Preview">`;
                }
            }
            reader.readAsDataURL(this.files[0]);
        }
    });
});
</script>
{% endblock %}